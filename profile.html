<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý tài khoản | linhkien4u</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #cart-count {
            position: absolute; top: -8px; right: -10px; background-color: red; color: white;
            border-radius: 50%; padding: 0px 6px; font-size: 12px; font-weight: bold;
            border: 2px solid #111827; display: none;
        }
        .group:hover .group-hover\:block { display: block; }
        /* Hiệu ứng spinner */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-gray-900 text-white sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold">linhkien4u</a>
            <nav class="flex items-center gap-4 text-sm">
                <a href="index.html" class="hover:text-yellow-400 transition py-2">Trang chủ</a>
                <a href="product.html" class="hover:text-yellow-400 transition py-2">Sản phẩm</a>
                <a href="cart.html" class="relative hover:text-yellow-400 transition flex items-center py-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    <span id="cart-count">0</span>
                </a>
                 <div id="auth-section" class="flex items-center gap-4">
                    <!-- JS sẽ điền vào đây -->
                 </div>
            </nav>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Tài Khoản Của Tôi</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <nav class="bg-white p-4 rounded-lg shadow-sm">
                    <ul>
                        <li><a href="#info" class="tab-link block py-2 px-3 rounded-md">Thông tin cá nhân</a></li>
                        <li><a href="#password" class="tab-link block py-2 px-3 rounded-md">Đổi mật khẩu</a></li>
                        <li><a href="my-orders.html" class="text-gray-700 hover:bg-gray-100 block py-2 px-3 rounded-md">Lịch sử đơn hàng</a></li>
                    </ul>
                </nav>
            </div>

            <div class="md:col-span-2">
                <!-- TAB 1: THÔNG TIN CÁ NHÂN -->
                <div id="info" class="tab-content bg-white p-6 rounded-lg shadow-sm hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-5">Thông tin cá nhân</h2>
                    
                    <div class="flex flex-col items-center mb-6">
                        <img id="avatar-preview" src="./images/Other/default-avatar.png" alt="Ảnh đại diện" class="w-32 h-32 rounded-full object-cover border-4 border-gray-200">
                        <label for="avatar-upload" class="mt-3 bg-gray-200 text-gray-700 text-sm font-semibold px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-300 transition">
                            Thay đổi ảnh
                        </label>
                        <input type="file" id="avatar-upload" class="hidden" accept="image/png, image/jpeg, image/jpg">
                    </div>

                    <form id="profile-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="profile-email" readonly class="w-full mt-1 px-4 py-2 bg-gray-100 border border-gray-300 rounded-md cursor-not-allowed">
                        </div>
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                            <input type="text" id="profile-name" required class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="profile-phone" class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                            <input type="tel" id="profile-phone" placeholder="Chưa có số điện thoại" class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="profile-address" class="block text-sm font-medium text-gray-700">Địa chỉ</label>
                            <textarea id="profile-address" rows="3" placeholder="Chưa có địa chỉ" class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="pt-2">
                            <button type="submit" id="update-profile-btn" class="w-full bg-blue-600 text-white px-6 py-2.5 rounded-md hover:bg-blue-700 transition font-semibold flex items-center justify-center">
                                <span class="btn-text">Cập nhật thông tin</span>
                                <span class="spinner hidden ml-2"></span>
                            </button>
                            <p id="profile-message" class="text-sm text-center mt-3 min-h-[20px]"></p>
                        </div>
                    </form>
                </div>

                <!-- TAB 2: ĐỔI MẬT KHẨU -->
                <div id="password" class="tab-content bg-white p-6 rounded-lg shadow-sm hidden">
                     <h2 class="text-2xl font-semibold text-gray-800 mb-5">Đổi mật khẩu</h2>
                     <form id="password-form" class="space-y-4">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-gray-700">Mật khẩu hiện tại</label>
                            <input type="password" id="current-password" required class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700">Mật khẩu mới</label>
                            <input type="password" id="new-password" required class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="password-strength-message" class="mt-2 text-sm"></div>
                        </div>
                        <div>
                            <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Xác nhận mật khẩu mới</label>
                            <input type="password" id="confirm-new-password" required class="w-full mt-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="pt-2">
                             <button type="submit" class="w-full bg-green-600 text-white px-6 py-2.5 rounded-md hover:bg-green-700 transition font-semibold">Đổi mật khẩu</button>
                             <p id="password-message" class="text-sm text-center mt-3 min-h-[20px]"></p>
                        </div>
                     </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-900 text-white py-6 text-center mt-10">
        <p class="text-sm">© 2025 linhkien4u. All rights reserved.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) {
            alert("Vui lòng đăng nhập để truy cập trang này.");
            window.location.href = 'login.html';
            return;
        }

        const profileForm = document.getElementById('profile-form');
        const passwordForm = document.getElementById('password-form');
        const profileEmailInput = document.getElementById('profile-email');
        const profileNameInput = document.getElementById('profile-name');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileAddressInput = document.getElementById('profile-address');
        const profileMessage = document.getElementById('profile-message');
        const passwordMessage = document.getElementById('password-message');
        const newPasswordInput = document.getElementById('new-password');
        const passwordStrengthMessage = document.getElementById('password-strength-message');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const avatarUpload = document.getElementById('avatar-upload');
        const avatarPreview = document.getElementById('avatar-preview');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const btnText = updateProfileBtn.querySelector('.btn-text');
        const spinner = updateProfileBtn.querySelector('.spinner');
        let newAvatarBase64 = null;

        // --- HIỂN THỊ THÔNG TIN BAN ĐẦU ---
        profileEmailInput.value = loggedInUser.email;
        profileNameInput.value = loggedInUser.name;
        profilePhoneInput.value = loggedInUser.phone || '';
        profileAddressInput.value = loggedInUser.address || '';
        if (loggedInUser.avatar) {
            avatarPreview.src = loggedInUser.avatar;
        }

        // --- LOGIC UPLOAD VÀ NÉN ẢNH ---
        function resizeImage(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }
        avatarUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert('Vui lòng chọn một file ảnh hợp lệ.');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước ảnh gốc không được vượt quá 5MB.');
                return;
            }
            try {
                const resizedBase64 = await resizeImage(file, 400, 400, 0.8);
                avatarPreview.src = resizedBase64;
                newAvatarBase64 = resizedBase64;
            } catch (error) {
                console.error("Lỗi khi nén ảnh:", error);
                alert("Đã có lỗi xảy ra khi xử lý ảnh của bạn.");
            }
        });

        // --- LOGIC TAB ---
        function activateTab(tabId) {
            tabLinks.forEach(link => {
                const isActive = link.getAttribute('href') === `#${tabId}`;
                link.classList.toggle('active', isActive);
                link.classList.toggle('font-semibold', isActive);
                link.classList.toggle('text-blue-600', isActive);
                link.classList.toggle('text-gray-700', !isActive);
                link.classList.toggle('hover:bg-gray-100', !isActive);
            });
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== tabId);
            });
        }
        function handleInitialTab() {
            const hash = window.location.hash.substring(1);
            activateTab(hash || 'info');
        }
        tabLinks.forEach(link => {
            if (link.getAttribute('href').startsWith('#')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    activateTab(targetId);
                    history.pushState(null, null, `#${targetId}`);
                });
            }
        });
        handleInitialTab();

        // --- LOGIC FORM THÔNG TIN CÁ NHÂN ---
        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateProfileBtn.disabled = true;
            updateProfileBtn.classList.add('opacity-75');
            btnText.textContent = 'Đang xử lý...';
            spinner.classList.remove('hidden');
            profileMessage.textContent = '';

            const newName = profileNameInput.value.trim();
            if (!newName) {
                profileMessage.textContent = 'Họ và tên không được để trống.';
                profileMessage.className = 'text-red-500 text-sm text-center mt-3';
                updateProfileBtn.disabled = false;
                updateProfileBtn.classList.remove('opacity-75');
                btnText.textContent = 'Cập nhật thông tin';
                spinner.classList.add('hidden');
                return;
            }

            const newPhone = profilePhoneInput.value.trim();
            const newAddress = profileAddressInput.value.trim();
            let users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === loggedInUser.email);
            if (userIndex !== -1) {
                users[userIndex].name = newName;
                users[userIndex].phone = newPhone;
                users[userIndex].address = newAddress;
                loggedInUser.name = newName;
                loggedInUser.phone = newPhone;
                loggedInUser.address = newAddress;
                if (newAvatarBase64) {
                    users[userIndex].avatar = newAvatarBase64;
                    loggedInUser.avatar = newAvatarBase64;
                }
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                profileMessage.textContent = 'Cập nhật thông tin thành công!';
                profileMessage.className = 'text-green-600 text-sm text-center mt-3';
                newAvatarBase64 = null;
                setupHeader();
            } else {
                profileMessage.textContent = 'Lỗi: Không tìm thấy người dùng.';
                profileMessage.className = 'text-red-500 text-sm text-center mt-3';
            }
            setTimeout(() => {
                updateProfileBtn.disabled = false;
                updateProfileBtn.classList.remove('opacity-75');
                btnText.textContent = 'Cập nhật thông tin';
                spinner.classList.add('hidden');
            }, 1000);
        });

        // --- LOGIC FORM ĐỔI MẬT KHẨU ---
        function checkPasswordStrength(password) {
            return password.length >= 8 && /[A-Z]/.test(password) && /[a-z]/.test(password) && /\d/.test(password) && /[!@#$%^&*(),.?":{}|<>]/.test(password);
        }
        function updateStrengthUI(password) {
            const requirements = [
                { met: password.length >= 8, text: 'Ít nhất 8 ký tự' },
                { met: /[A-Z]/.test(password), text: 'Chứa chữ cái viết hoa (A-Z)' },
                { met: /[a-z]/.test(password), text: 'Chứa chữ cái viết thường (a-z)' },
                { met: /\d/.test(password), text: 'Chứa ít nhất một chữ số (0-9)' },
                { met: /[!@#$%^&*(),.?":{}|<>]/.test(password), text: 'Chứa ký tự đặc biệt (!@#...)' }
            ];
            passwordStrengthMessage.innerHTML = `<ul class="space-y-1">${requirements.map(req => `<li class="${req.met ? 'text-green-600' : 'text-gray-500'}">${req.met ? '✓' : '•'} ${req.text}</li>`).join('')}</ul>`;
        }
        newPasswordInput.addEventListener('input', () => updateStrengthUI(newPasswordInput.value));
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            passwordMessage.textContent = '';
            if (currentPassword !== loggedInUser.password) {
                passwordMessage.textContent = 'Mật khẩu hiện tại không chính xác.';
                passwordMessage.className = 'text-red-500 text-sm text-center mt-3';
                return;
            }
            if (!checkPasswordStrength(newPassword)) {
                passwordMessage.textContent = 'Mật khẩu mới không đủ mạnh.';
                passwordMessage.className = 'text-red-500 text-sm text-center mt-3';
                return;
            }
            if (newPassword !== confirmNewPassword) {
                passwordMessage.textContent = 'Mật khẩu mới và xác nhận mật khẩu không khớp.';
                passwordMessage.className = 'text-red-500 text-sm text-center mt-3';
                return;
            }
            let users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(user => user.email === loggedInUser.email);
            if (userIndex > -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
                loggedInUser.password = newPassword;
                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                passwordMessage.textContent = 'Đổi mật khẩu thành công!';
                passwordMessage.className = 'text-green-600 text-sm text-center mt-3';
                passwordForm.reset();
                passwordStrengthMessage.innerHTML = '';
            } else {
                passwordMessage.textContent = 'Lỗi không xác định.';
                passwordMessage.className = 'text-red-500 text-sm text-center mt-3';
            }
        });

        // --- CẬP NHẬT HEADER ---
        function setupHeader() {
            const authSection = document.getElementById('auth-section');
            if (authSection) {
                 const avatarSrc = loggedInUser.avatar || './images/Other/default-avatar.png';
                 const userMenuHTML = `
                    <div class="relative group py-2">
                      <a href="profile.html" class="flex items-center gap-2 hover:opacity-80 transition">
                        <img src="${avatarSrc}" class="w-8 h-8 rounded-full object-cover border-2 border-gray-500">
                        <span class="font-semibold">${loggedInUser.name}</span>
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                      </a>
                      <div class="absolute right-0 top-full pt-2 -mt-px w-56 bg-transparent hidden group-hover:block z-50">
                        <div class="bg-white text-gray-800 rounded-md shadow-lg border border-gray-200">
                            <div class="px-4 py-3 border-b">
                                <p class="text-sm font-semibold truncate">${loggedInUser.name}</p>
                                <p class="text-xs text-gray-500 truncate">${loggedInUser.email}</p>
                            </div>
                            <ul class="py-1">
                                <li><a href="profile.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Quản lý tài khoản</a></li>
                                <li><a href="wishlist.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Sản phẩm yêu thích</a></li>
                                ${loggedInUser.role === 'admin' ? `<li><a href="admin.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Trang quản trị</a></li>` : '<li><a href="my-orders.html" class="block px-4 py-2 text-sm hover:bg-gray-100">Đơn hàng của tôi</a></li>'}
                            </ul>
                        </div>
                      </div>
                    </div>`;
                 authSection.innerHTML = userMenuHTML + `<button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition text-sm font-semibold">Đăng xuất</button>`;
            }
        }

        window.logout = function() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                localStorage.removeItem('loggedInUser');
                window.location.href = 'index.html'; 
            }
        }

        setupHeader();
    });
    </script>
</body>
</html>